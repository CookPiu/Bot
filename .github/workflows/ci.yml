name: CI Pipeline

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  
# ä½œä¸šå®šä¹‰
jobs:
  # ä½œä¸š1: ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort mypy pytest-cov
        
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        # æ£€æŸ¥ä»£ç æ ¼å¼
        black --check --diff .
        
    - name: å¯¼å…¥æ’åºæ£€æŸ¥
      run: |
        isort --check-only --diff .
        
    - name: ä»£ç è§„èŒƒæ£€æŸ¥
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: ç±»å‹æ£€æŸ¥
      run: |
        mypy app/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true  # ç±»å‹æ£€æŸ¥ä¸å¼ºåˆ¶è¦æ±‚é€šè¿‡

  # ä½œä¸š2: å•å…ƒæµ‹è¯•
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality-check
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio pytest-mock
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        python -m pytest tests/ -v --cov=app --cov-report=xml --cov-report=html --cov-report=term
      env:
        # æµ‹è¯•ç¯å¢ƒå˜é‡
        FEISHU_APP_ID: test_app_id
        FEISHU_APP_SECRET: test_app_secret
        DEEPSEEK_KEY: test_deepseek_key
        
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        
    - name: ä¿å­˜æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-py${{ matrix.python-version }}
        path: |
          htmlcov/
          coverage.xml
          pytest-report.xml

  # ä½œä¸š3: é›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      # RedisæœåŠ¡ (å¦‚æœéœ€è¦)
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio
        
    - name: å¯åŠ¨FastAPIæœåŠ¡
      run: |
        # åå°å¯åŠ¨æœåŠ¡ç”¨äºé›†æˆæµ‹è¯•
        python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
        sleep 10  # ç­‰å¾…æœåŠ¡å¯åŠ¨
      env:
        FEISHU_APP_ID: test_app_id
        FEISHU_APP_SECRET: test_app_secret
        
    - name: å¥åº·æ£€æŸ¥
      run: |
        curl -f http://localhost:8000/health || exit 1
        curl -f http://localhost:8000/api/v1/health || exit 1
        
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        python -m pytest tests/integration/ -v
      env:
        TEST_SERVER_URL: http://localhost:8000

  # ä½œä¸š4: å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ä¾èµ–æ‰«æå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        
    - name: æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§
      run: |
        safety check -r requirements.txt
      continue-on-error: true
        
    - name: ä»£ç å®‰å…¨æ‰«æ
      run: |
        bandit -r app/ -f json -o bandit-report.json
      continue-on-error: true
        
    - name: ä¸Šä¼ å®‰å…¨æ‰«ææŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json

  # ä½œä¸š5: Dockeræ„å»ºæµ‹è¯•
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [quality-check, unit-tests]
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: æ„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: task-bot:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: æµ‹è¯•Dockeré•œåƒ
      run: |
        # è¿è¡Œå®¹å™¨å¹¶æµ‹è¯•
        docker run -d --name test-container -p 8000:8000 task-bot:test
        sleep 15
        curl -f http://localhost:8000/health || exit 1
        docker stop test-container

  # ä½œä¸š6: æå–ä»»åŠ¡IDå¹¶é€šçŸ¥ä»»åŠ¡ç³»ç»Ÿ
  notify-task-system:
    name: Notify Task System
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, docker-build]
    if: always() && (contains(github.event.head_commit.message, 'TASK') || contains(github.event.pull_request.title, 'TASK'))
    
    steps:
    - name: æå–ä»»åŠ¡ID
      id: extract-task
      run: |
        # ä»commitæ¶ˆæ¯æˆ–PRæ ‡é¢˜ä¸­æå–ä»»åŠ¡ID
        COMMIT_MSG="${{ github.event.head_commit.message || github.event.pull_request.title }}"
        TASK_ID=$(echo "$COMMIT_MSG" | grep -oP 'TASK\d+' | head -1)
        
        if [ -n "$TASK_ID" ]; then
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°ä»»åŠ¡ID: $TASK_ID"
        else
          echo "æœªæ‰¾åˆ°ä»»åŠ¡ID"
        fi
        
    - name: è®¡ç®—CIç»“æœ
      id: ci-result
      run: |
        # è®¡ç®—æ•´ä½“CIçŠ¶æ€
        QUALITY_STATUS="${{ needs.quality-check.result }}"
        UNIT_TEST_STATUS="${{ needs.unit-tests.result }}"
        INTEGRATION_STATUS="${{ needs.integration-tests.result }}"
        DOCKER_STATUS="${{ needs.docker-build.result }}"
        
        # åˆ¤æ–­æ•´ä½“æ˜¯å¦é€šè¿‡
        if [[ "$QUALITY_STATUS" == "success" && "$UNIT_TEST_STATUS" == "success" && "$INTEGRATION_STATUS" == "success" && "$DOCKER_STATUS" == "success" ]]; then
          echo "overall_status=success" >> $GITHUB_OUTPUT
          echo "ci_passed=true" >> $GITHUB_OUTPUT
        else
          echo "overall_status=failure" >> $GITHUB_OUTPUT  
          echo "ci_passed=false" >> $GITHUB_OUTPUT
        fi
        
        echo "quality_passed=$([[ \"$QUALITY_STATUS\" == \"success\" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
        echo "tests_passed=$([[ \"$UNIT_TEST_STATUS\" == \"success\" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
        echo "integration_passed=$([[ \"$INTEGRATION_STATUS\" == \"success\" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
        echo "build_passed=$([[ \"$DOCKER_STATUS\" == \"success\" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
        
    - name: å‘é€CIç»“æœåˆ°ä»»åŠ¡ç³»ç»Ÿ
      if: steps.extract-task.outputs.task_id != ''
      run: |
        # æ„å»ºwebhook payload
        PAYLOAD=$(cat <<EOF
        {
          "action": "completed",
          "workflow_run": {
            "id": "${{ github.run_id }}",
            "name": "${{ github.workflow }}",
            "status": "completed",
            "conclusion": "${{ steps.ci-result.outputs.overall_status }}",
            "head_sha": "${{ github.sha }}",
            "html_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          },
          "repository": {
            "name": "${{ github.event.repository.name }}",
            "full_name": "${{ github.repository }}"
          },
          "check_run": {
            "name": "CI Pipeline",
            "status": "completed", 
            "conclusion": "${{ steps.ci-result.outputs.overall_status }}",
            "head_sha": "${{ github.sha }}",
            "output": {
              "title": "CI Pipeline Results",
              "summary": "GitHub Actions CI Pipeline completed",
              "text": "Quality Check: ${{ needs.quality-check.result }}\nUnit Tests: ${{ needs.unit-tests.result }}\nIntegration Tests: ${{ needs.integration-tests.result }}\nDocker Build: ${{ needs.docker-build.result }}"
            }
          },
          "task_metadata": {
            "task_id": "${{ steps.extract-task.outputs.task_id }}",
            "ci_passed": ${{ steps.ci-result.outputs.ci_passed }},
            "quality_passed": ${{ steps.ci-result.outputs.quality_passed }},
            "tests_passed": ${{ steps.ci-result.outputs.tests_passed }},
            "integration_passed": ${{ steps.ci-result.outputs.integration_passed }},
            "build_passed": ${{ steps.ci-result.outputs.build_passed }},
            "coverage_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "commit_message": "${{ github.event.head_commit.message || github.event.pull_request.title }}",
            "branch": "${{ github.ref_name }}",
            "pr_url": "${{ github.event.pull_request.html_url || '' }}"
          }
        }
        EOF
        )
        
        # å‘é€åˆ°ä»»åŠ¡ç³»ç»Ÿwebhook
        if [ -n "${{ secrets.TASK_WEBHOOK_URL }}" ]; then
          echo "å‘é€CIç»“æœåˆ°ä»»åŠ¡ç³»ç»Ÿ..."
          
          # è®¡ç®—ç­¾å (å¦‚æœè®¾ç½®äº†å¯†é’¥)
          if [ -n "${{ secrets.GITHUB_WEBHOOK_SECRET }}" ]; then
            SIGNATURE="sha256=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.GITHUB_WEBHOOK_SECRET }}" -binary | base64)"
            curl -X POST "${{ secrets.TASK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Event: workflow_run" \
              -H "X-Hub-Signature-256: $SIGNATURE" \
              -H "X-GitHub-Delivery: ${{ github.run_id }}" \
              -d "$PAYLOAD" \
              --fail-with-body
          else
            curl -X POST "${{ secrets.TASK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Event: workflow_run" \
              -H "X-GitHub-Delivery: ${{ github.run_id }}" \
              -d "$PAYLOAD" \
              --fail-with-body
          fi
          
          echo "CIç»“æœå·²å‘é€åˆ°ä»»åŠ¡ç³»ç»Ÿ"
        else
          echo "æœªé…ç½®TASK_WEBHOOK_URLï¼Œè·³è¿‡é€šçŸ¥"
        fi

  # ä½œä¸š7: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [quality-check, unit-tests, integration-tests, security-scan, docker-build]
    if: always()
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v3
      
    - name: ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
      run: |
        # åˆ›å»ºæµ‹è¯•æŠ¥å‘Šç›®å½•
        mkdir -p test-reports
        
        # ç”ŸæˆMarkdownæµ‹è¯•æŠ¥å‘Š
        cat > test-reports/ci-report.md << 'EOF'
        # ğŸ” CI Pipeline æµ‹è¯•æŠ¥å‘Š
        
        ## ğŸ“Š æ€»è§ˆ
        
        - **å·¥ä½œæµID**: ${{ github.run_id }}
        - **æäº¤SHA**: ${{ github.sha }}
        - **åˆ†æ”¯**: ${{ github.ref_name }}
        - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
        - **æ‰§è¡Œæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ## âœ… æ£€æŸ¥ç»“æœ
        
        | æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | ç»“æœ |
        |---------|------|------|
        | ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.quality-check.result }} | ${{ needs.quality-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
        | å•å…ƒæµ‹è¯• | ${{ needs.unit-tests.result }} | ${{ needs.unit-tests.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
        | é›†æˆæµ‹è¯• | ${{ needs.integration-tests.result }} | ${{ needs.integration-tests.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
        | å®‰å…¨æ‰«æ | ${{ needs.security-scan.result }} | ${{ needs.security-scan.result == 'success' && 'âœ… é€šè¿‡' || needs.security-scan.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |
        | Dockeræ„å»º | ${{ needs.docker-build.result }} | ${{ needs.docker-build.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
        
        ## ğŸ”— ç›¸å…³é“¾æ¥
        
        - [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        - [ä»£ç è¦†ç›–ç‡æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ## ğŸ“ æäº¤ä¿¡æ¯
        
        ```
        ${{ github.event.head_commit.message || github.event.pull_request.title }}
        ```
        
        ---
        
        æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: ci-test-report
        path: test-reports/
        retention-days: 30 